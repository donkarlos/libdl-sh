#! /bin/sh
#-----------------------------------------------------------------------------
#   gensubst			- Generate output variables
#
#   Copyright (C) 2013-2015 Das Computerlabor (DCl-M)
#
#   This library is free software; you can redistribute it and/or
#   modify it under the terms of the GNU Lesser General Public License
#   as published by the Free Software Foundation; either
#   version 2.1 of the License, or (at your option) any later version.
#
#   This library is distributed in the hope that it will be useful,
#   but WITHOUT ANY WARRANTY; without even the implied warranty of
#   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
#   Lesser General Public License for more details.
#
#   You should have received a copy of the GNU Lesser General Public License
#   along with this library; if not, write to the Free Software Founda-
#   tion, Inc., 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301 USA
#
#   AUTHOR(S):	ks	Karl Schmitz <ks@computerlabor.org>
#
#   WRITTEN BY:	ks	2013-02-12
#   CHANGED BY:	ks	2013-03-09	Move script comment stripping to
#					`auto/gensubst.sed'.
#		ks	2013-04-17	Fix and optimize template extraction.
#					Allow to tune the finishing mechanism
#					with $(FINISH_ANTE/POST_SEDFLAGS).
#-----------------------------------------------------------------------------
#   Initialization:
#-----------------------------------------------------------------------------
LC_ALL=C; export LC_ALL			# Avoid locale insanities.

cr_upper=ABCDEFGHIJKLMNOPQRSTUVWXYZ	# Define basic character ranges for
cr_lower=abcdefghijklmnopqrstuvwxyz	# upper-/lowercase letters and
cr_digit=0123456789			# decimal digits.
cr_alpha=$cr_upper$cr_lower		# Combine character ranges for
cr_alnum=$cr_alpha$cr_digit		# letters and alphanumerics.

re_prefix=@
re_suffix=@
re_variable="[_$cr_alpha][_$cr_alnum]*"
rs_prefix='$('
rs_suffix=')'

#-----------------------------------------------------------------------------
#   Generate output variable:
#-----------------------------------------------------------------------------
if test $# -ge 1; then			# Output variable given?
    name=$1; shift			# Yes, fetch it.
    srcdir=`dirname "$0"`		# Auto-locate (top_)srcdir...
    until test -f "$srcdir"/configure.ac; do
	srcdir=`dirname "$srcdir"`
    done

    case $name in			# Which output variable?
	CONFIG_STATUS_DEPENDENCIES)
	    rs_top_srcdir="${rs_prefix}top_srcdir${rs_suffix}"
	    echo " $*" | sed 's| | '"$rs_top_srcdir"'/|g;s|^ ||'
	    ;;
	FINISH)
	    unfinished=`echo " $*" | sed 's| | '"$srcdir"'/|g;s|^ ||'`
	    templates="`sed '
		:1
		/^[^'"$re_prefix"']*'"$re_prefix"'/!d;s///
		/^'"$re_variable$re_suffix"'/{
		    h;s///;x;s/'"$re_suffix"'.*$//p;x
		};b1
	    ' $unfinished`" || {
		echo "$0: Update AF_FINISH_FILES() invocation to generate $name!" >&2
		echo false
		exit 2
	    }
	    if test -n "$templates"; then
		rs_ante="${rs_prefix}FINISH_ANTE_SEDFLAGS${rs_suffix} -f $0.sed -e '"
		rs_post="' ${rs_prefix}FINISH_POST_SEDFLAGS${rs_suffix}"
		echo "$templates" | sort | uniq | sed '
		    s/^\(.*\)$/s|'"$re_prefix"'\1'"$re_suffix"'|'"$rs_prefix"'\1'"$rs_suffix"'|g/
		    H;$!d
		    x;s|\n|;|g;s|^;||;s|^|sed '"$rs_ante"'|;s|$|'"$rs_post"'|
		'
	    else
		echo "$0: No templates found. Do you still need me?" >&2
		echo cat
	    fi
	    ;;
	*)
	    echo "$0: Don't know how to generate $name!" >&2
	    exit 1
	    ;;
    esac
else
    echo "Usage: $0 VARIABLE [UNFINISHED ...]" >&2
    exit 2
fi
